"use strict";!function(){var pnrmTourDiv;if(document.querySelector(".pnrm-tour")){console.log("panorom tour page running");var btnAdd=document.querySelector(".pnrm-tour .btn-add"),trTags=document.querySelectorAll(".pnrm-tour tr"),modalAdd=document.querySelector(".pnrm-tour .modal-add"),modalEdit=document.querySelector(".pnrm-tour .modal-edit"),modalCopy=document.querySelector(".pnrm-tour .modal-copy"),modalDelete=document.querySelector(".pnrm-tour .modal-delete"),dialogBoxes=document.querySelectorAll(".pnrm-tour .dialog-box"),modals=document.querySelectorAll(".pnrm-tour .modal"),formModalAdd=document.querySelector(".pnrm-tour .modal-add form"),btnCancelModalAdd=document.querySelector(".pnrm-tour .modal-add .btn-cancel"),formModalEdit=document.querySelector(".pnrm-tour .modal-edit form"),btnCancelModalEdit=document.querySelector(".pnrm-tour .modal-edit .btn-cancel"),formModalCopy=document.querySelector(".pnrm-tour .modal-copy form"),btnCancelModalCopy=document.querySelector(".pnrm-tour .modal-copy .btn-cancel"),formModalDelete=document.querySelector(".pnrm-tour .modal-delete form"),btnCancelModalDelete=document.querySelector(".pnrm-tour .modal-delete .btn-cancel"),inputIsActivated,isActivated="true"===document.querySelector(".pnrm-tour #input-is-activated").value;dialogBoxes.forEach((function(dialogBox){dialogBox.onclick=function(e){e.stopPropagation()}})),modals.forEach((function(modal){modal.onclick=function(e){modal.classList.remove("show")}})),btnAdd.onclick=function(){modalAdd.classList.add("show"),modalAdd.querySelector("#input-add-tour-name").focus()},btnCancelModalAdd.onclick=function(){modalAdd.classList.remove("show")},formModalAdd.onsubmit=function(e){var tourName;e.preventDefault(),submitForm("add","",modalAdd.querySelector("#input-add-tour-name").value)},btnCancelModalEdit.onclick=function(){modalEdit.classList.remove("show")},formModalEdit.onsubmit=function(e){e.preventDefault();var tourName=modalEdit.querySelector("#input-edit-tour-name").value,postId;submitForm("edit",modalEdit.querySelector("#input-edit-post-id").value,tourName)},btnCancelModalCopy.onclick=function(){modalCopy.classList.remove("show")},formModalCopy.onsubmit=function(e){e.preventDefault();var tourName=modalCopy.querySelector("#input-copy-tour-name").value,postId;submitForm("copy",modalCopy.querySelector("#input-copy-post-id").value,tourName)},btnCancelModalDelete.onclick=function(){modalDelete.classList.remove("show")},formModalDelete.onsubmit=function(e){var postId;e.preventDefault(),submitForm("delete",modalDelete.querySelector("#input-delete-post-id").value,"")},trTags.forEach((function(tr){tr.onclick=function(e){if(e.target.parentElement.classList.contains("btn-edit")||e.target.classList.contains("btn-edit")){var tourName=tr.querySelector(".tour-name").textContent,postId=tr.querySelector(".post-id").textContent;modalEdit.querySelector("#input-edit-post-id").value=postId,modalEdit.querySelector("#input-edit-tour-name").value=tourName,modalEdit.classList.add("show"),modalEdit.querySelector("#input-edit-tour-name").focus()}if(e.target.parentElement.classList.contains("btn-copy")||e.target.classList.contains("btn-copy")){var tourName=tr.querySelector(".tour-name").textContent,postId=tr.querySelector(".post-id").textContent;modalCopy.querySelector("#input-copy-post-id").value=postId,modalCopy.querySelector("#input-copy-tour-name").value=tourName+"-copy",modalCopy.classList.add("show"),modalCopy.querySelector("#input-copy-tour-name").focus()}if(e.target.parentElement.classList.contains("btn-delete")||e.target.classList.contains("btn-delete")){var tourName=tr.querySelector(".tour-name").textContent,postId=tr.querySelector(".post-id").textContent;modalDelete.querySelector("#input-delete-post-id").value=postId,modalDelete.querySelector("#span-delete-tour-name").textContent=tourName,modalDelete.classList.add("show")}}}));var modalExport=document.querySelector(".pnrm-tour .modal-export"),modalExportBtnInfo=document.querySelector(".pnrm-tour .modal-export .box-info-button"),modalExportDivInfoMessage=document.querySelector(".pnrm-tour .modal-export .box-info-message"),modalExportSelectTour=document.querySelector(".pnrm-tour .modal-export #select-export-tour"),modalExportSpanTourLoading=document.querySelector(".pnrm-tour .modal-export .loading-msg"),modalExportSpanTourError=document.querySelector(".pnrm-tour .modal-export .error-msg"),modalExportDivResources=document.querySelector(".pnrm-tour .modal-export .div-resources"),modalExportCheckboxSelectAll=document.querySelector(".pnrm-tour .modal-export .div-select-all input"),modalExportBtnDownload=document.querySelector(".pnrm-tour .modal-export #btn-download-resources"),modalExportInputTourName=document.querySelector(".pnrm-tour .modal-export #input-export-tour-name"),modalExportBtnExport=document.querySelector(".pnrm-tour .modal-export #btn-submit-export"),modalExportBtnCancel=document.querySelector(".pnrm-tour .modal-export .btn-cancel"),exportObj={},btnExportTop;document.querySelector(".pnrm-tour .btn-export-top").onclick=function(){isActivated&&(modalExportSelectTour.value="",resetModalExport(),modalExport.classList.add("show"))},modalExportBtnInfo.onclick=function(){modalExportDivInfoMessage.classList.toggle("open")},modalExportSelectTour.onchange=function(){resetModalExport();var selectedOptionText=modalExportSelectTour.options[modalExportSelectTour.selectedIndex].text,selectedOptionValue=modalExportSelectTour.value;if(""!==selectedOptionValue){modalExportSpanTourLoading.classList.add("show");var dataToSend={action:"get_tour",post_id:selectedOptionValue};jQuery.post(ajaxurl,dataToSend).done((function(response){if(response.error)return modalExportSpanTourLoading.classList.remove("show"),void modalExportSpanTourError.classList.add("show");modalExportSpanTourLoading.classList.remove("show"),exportObj.type="tour",exportObj.tourName=selectedOptionText;try{exportObj.config=JSON.parse(response.data)}catch(e){return void console.log("error in selected tour config json")}fillExportResourcesDiv(),modalExportInputTourName.value=exportObj.tourName})).fail((function(xhr,status,error){modalExportSpanTourLoading.classList.remove("show"),modalExportSpanTourError.classList.add("show")}))}},modalExportCheckboxSelectAll.onchange=function(){var divResourcesAllRows=modalExportDivResources.querySelectorAll(".each-row");0!==divResourcesAllRows.length&&divResourcesAllRows.forEach((function(divEachRow){modalExportCheckboxSelectAll.checked?(divEachRow.dataset.selected="yes",divEachRow.querySelector("input").checked=!0):(divEachRow.dataset.selected="no",divEachRow.querySelector("input").checked=!1)}))},modalExportBtnDownload.onclick=function(){var divResourcesAllRows=modalExportDivResources.querySelectorAll(".each-row");0!==divResourcesAllRows.length&&divResourcesAllRows.forEach((function(divEachRow){if(divEachRow.querySelector("input").checked){var url=divEachRow.querySelector("span:nth-child(2)").textContent,a=document.createElement("a");a.href=url;var filename=url.split("/").pop();filename=filename.split("?")[0],a.download=filename,a.setAttribute("target","_blank"),document.body.appendChild(a),a.click(),document.body.removeChild(a)}}))},modalExportInputTourName.oninput=function(){exportObj.tourName=modalExportInputTourName.value},modalExportBtnExport.onclick=function(){if(!isActivated)return;if(void 0===exportObj.tourName||void 0===exportObj.config)return;var exportText=JSON.stringify(exportObj);const link=document.createElement("a"),file=new Blob([exportText],{type:"text/plain"});link.href=URL.createObjectURL(file),link.download="panorom_tour_"+exportObj.tourName,link.click(),URL.revokeObjectURL(link.href)},modalExportBtnCancel.onclick=function(){modalExport.classList.remove("show")};var modalImport=document.querySelector(".pnrm-tour .modal-import"),modalImportBtnInfo=document.querySelector(".pnrm-tour .modal-import .box-info-button"),modalImportDivInfoMessage=document.querySelector(".pnrm-tour .modal-import .box-info-message"),modalImportInputFile=document.querySelector(".pnrm-tour .modal-import #input-import-file"),modalImportDivResources=document.querySelector(".pnrm-tour .modal-import .div-resources"),modalImportCheckboxSelectAll=document.querySelector(".pnrm-tour .modal-import .div-select-all input"),modalImportInputDomain=document.querySelector(".pnrm-tour .modal-import #input-change-selected-domain"),modalImportBtnApplyDomainChange=document.querySelector(".pnrm-tour .modal-import #btn-apply-domain-change"),modalImportInputPath=document.querySelector(".pnrm-tour .modal-import #input-change-selected-path"),modalImportBtnApplyPathChange=document.querySelector(".pnrm-tour .modal-import #btn-apply-path-change"),modalImportInputTourName=document.querySelector(".pnrm-tour .modal-import #input-change-tour-name"),modalImportDivConfirmOverwrite=document.querySelector(".pnrm-tour .modal-import .flex-overwrite-tour"),modalImportCheckboxConfirmOverwrite=document.querySelector(".pnrm-tour .modal-import #checkbox-overwrite-tour"),modalImportBtnImport=document.querySelector(".pnrm-tour .modal-import #btn-submit-import"),modalImportBtnCancel=document.querySelector(".pnrm-tour .modal-import .btn-cancel"),importObj={},btnImportTop=document.querySelector(".pnrm-tour .btn-import-top"),modalImportSiteUrlValue=document.querySelector(".pnrm-tour #site-url").value,inputTourArray=document.querySelector(".pnrm-tour #input-import-tour-names");btnImportTop.onclick=function(){isActivated&&(modalImportInputFile.value="",resetModalImport(),modalImport.classList.add("show"))},modalImportBtnInfo.onclick=function(){modalImportDivInfoMessage.classList.toggle("open")},modalImportInputFile.onchange=function(){if(resetModalImport(),0!==modalImportInputFile.files.length){var selectedFile=modalImportInputFile.files[0],fileReader=new FileReader;fileReader.onload=function(){isImportFileCorrectFormat(fileReader.result)?(fillImportResourcesDiv(),modalImportInputDomain.value=modalImportSiteUrlValue,modalImportInputPath.value="wp-content/uploads/panorom",modalImportInputTourName.value=importObj.tourName,importTourNameAlreadyExist()&&modalImportDivConfirmOverwrite.classList.add("show")):console.log("file not correct format")},fileReader.readAsText(selectedFile)}},modalImportCheckboxSelectAll.onchange=function(){var divResourcesAllRows=modalImportDivResources.querySelectorAll(".each-row");0!==divResourcesAllRows.length&&divResourcesAllRows.forEach((function(divEachRow){modalImportCheckboxSelectAll.checked?(divEachRow.dataset.selected="yes",divEachRow.querySelector("input").checked=!0):(divEachRow.dataset.selected="no",divEachRow.querySelector("input").checked=!1)}))},modalImportBtnApplyDomainChange.onclick=function(){var newDomain=modalImportInputDomain.value,divResourcesAllRows=modalImportDivResources.querySelectorAll(".each-row");0!==divResourcesAllRows.length&&divResourcesAllRows.forEach((function(divEachRow){divEachRow.querySelector("input").checked&&(divEachRow.querySelector("span:nth-child(2)").textContent=newDomain)}))},modalImportBtnApplyPathChange.onclick=function(){var newPath=modalImportInputPath.value,divResourcesAllRows=modalImportDivResources.querySelectorAll(".each-row");0!==divResourcesAllRows.length&&divResourcesAllRows.forEach((function(divEachRow){divEachRow.querySelector("input").checked&&(divEachRow.querySelector("span:nth-child(3)").textContent=newPath)}))},modalImportInputTourName.oninput=function(){importObj.tourName=modalImportInputTourName.value,importTourNameAlreadyExist()?modalImportDivConfirmOverwrite.classList.add("show"):modalImportDivConfirmOverwrite.classList.remove("show")},modalImportBtnImport.onclick=function(){if(isActivated&&void 0!==importObj.tourName&&void 0!==importObj.config)if(!modalImportDivConfirmOverwrite.classList.contains("show")||modalImportCheckboxConfirmOverwrite.checked){var divResourcesAllRows;modalImportDivResources.querySelectorAll(".each-row").forEach((function(divEachRow){var oldUrl=divEachRow.dataset.resourceUrl,newUrl=divEachRow.querySelector("span:nth-child(2)").textContent+"/"+divEachRow.querySelector("span:nth-child(3)").textContent+"/"+divEachRow.querySelector("span:nth-child(4)").textContent;oldUrl!==newUrl&&updateImportResourceWithNew(importObj.config,oldUrl,newUrl)})),console.log(importObj);var tourName,postId="",config;submitForm("import","",importObj.tourName,JSON.stringify(importObj.config))}else console.log("overwrite checkbox should be checked")},modalImportBtnCancel.onclick=function(){modalImport.classList.remove("show")}}function submitForm(action,postId="",tourName="",config=""){var form=document.createElement("form"),inputAction=document.createElement("input"),inputPostId=document.createElement("input"),inputTourName=document.createElement("input"),inputConfig=document.createElement("input"),divNonce=document.querySelector(".pnrm-tour #div-pnrm-nonce");form.method="POST",form.action="",form.setAttribute("style","display: none;"),inputAction.name="action",inputAction.value="",form.appendChild(inputAction),inputPostId.name="post_id",inputPostId.value=postId,form.appendChild(inputPostId),inputTourName.name="tour_name",inputTourName.value=tourName,form.appendChild(inputTourName),inputConfig.name="config",inputConfig.value=config,form.appendChild(inputConfig);var allInputsNonce=divNonce.querySelectorAll("input");switch(allInputsNonce&&allInputsNonce.forEach((function(inputNonce){form.appendChild(inputNonce)})),action){case"add":inputAction.value="add";break;case"edit":inputAction.value="edit";break;case"copy":inputAction.value="copy";break;case"delete":inputAction.value="delete";break;case"import":inputAction.value="import"}document.body.appendChild(form),removeModalsListenersOnFormSubmit(),form.submit()}function removeModalsListenersOnFormSubmit(){dialogBoxes.forEach((function(dialogBox){dialogBox.onclick=""})),modals.forEach((function(modal){modal.onclick=""})),btnCancelModalAdd.onclick="",formModalAdd.onsubmit=function(e){e.preventDefault()},btnCancelModalEdit.onclick="",formModalEdit.onsubmit=function(e){e.preventDefault()},btnCancelModalCopy.onclick="",formModalCopy.onsubmit=function(e){e.preventDefault()},btnCancelModalDelete.onclick="",formModalDelete.onsubmit=function(e){e.preventDefault()},modalImportBtnCancel.onclick="",modalImportBtnImport.onclick=""}function resetModalExport(){exportObj={},modalExportDivResources.innerHTML="",modalExportCheckboxSelectAll.checked=!1,modalExportInputTourName.value="",modalExportSpanTourError.classList.remove("show"),modalExportSpanTourLoading.classList.remove("show")}function getExportResourcesArray(config){var params=[];for(let key in config.scenes){var scene=config.scenes[key];scene.panorama&&-1===params.indexOf(scene.panorama)&&params.push(scene.panorama),scene.thumbnail&&-1===params.indexOf(scene.thumbnail)&&params.push(scene.thumbnail),scene.preview&&-1===params.indexOf(scene.preview)&&params.push(scene.preview);for(let i in scene.hotSpots){var hotSpot=scene.hotSpots[i];hotSpot.infoImage&&-1===params.indexOf(hotSpot.infoImage)&&params.push(hotSpot.infoImage),hotSpot.infoVideo&&-1===params.indexOf(hotSpot.infoVideo)&&params.push(hotSpot.infoVideo)}}return params}function fillExportResourcesDiv(){var resourcesArray;getExportResourcesArray(exportObj.config).forEach((function(url){var divEachRow=document.createElement("div");divEachRow.setAttribute("class","each-row"),divEachRow.setAttribute("data-selected","no");var spanFirst=document.createElement("span"),inputCheckbox=document.createElement("input");inputCheckbox.setAttribute("type","checkbox"),inputCheckbox.onchange=function(){inputCheckbox.checked?divEachRow.setAttribute("data-selected","yes"):divEachRow.setAttribute("data-selected","no")},spanFirst.appendChild(inputCheckbox);var spanSecond=document.createElement("span");spanSecond.textContent=url,divEachRow.appendChild(spanFirst),divEachRow.appendChild(spanSecond),modalExportDivResources.appendChild(divEachRow)}))}function resetModalImport(){importObj={},modalImportDivResources.innerHTML="",modalImportCheckboxSelectAll.checked=!1,modalImportInputDomain.value="",modalImportInputPath.value="",modalImportInputTourName.value="",modalImportCheckboxConfirmOverwrite.checked=!1,modalImportDivConfirmOverwrite.classList.remove("show")}function isImportFileCorrectFormat(fileText){try{importObj=JSON.parse(fileText)}catch(e){return console.log("error in import file json parse"),!1}return void 0!==importObj.tourName&&void 0!==importObj.config}function getImportResourcesArray(config){var params=[];for(let key in config.scenes){var scene=config.scenes[key];scene.panorama&&-1===params.indexOf(scene.panorama)&&params.push(scene.panorama),scene.thumbnail&&-1===params.indexOf(scene.thumbnail)&&params.push(scene.thumbnail),scene.preview&&-1===params.indexOf(scene.preview)&&params.push(scene.preview);for(let i in scene.hotSpots){var hotSpot=scene.hotSpots[i];hotSpot.infoImage&&-1===params.indexOf(hotSpot.infoImage)&&params.push(hotSpot.infoImage),hotSpot.infoVideo&&-1===params.indexOf(hotSpot.infoVideo)&&params.push(hotSpot.infoVideo)}}return params}function fillImportResourcesDiv(){var resourcesArray;getImportResourcesArray(importObj.config).forEach((function(url){try{var urlObj=new URL(url),domainText=urlObj.origin,n=urlObj.pathname.lastIndexOf("/"),pathText=urlObj.pathname.substring(1,n),fileText=urlObj.pathname.substring(n+1),divEachRow=document.createElement("div");divEachRow.setAttribute("class","each-row"),divEachRow.setAttribute("data-resource-url",url),divEachRow.setAttribute("data-selected","no");var spanFirst=document.createElement("span"),inputCheckbox=document.createElement("input");inputCheckbox.setAttribute("type","checkbox"),inputCheckbox.onchange=function(){inputCheckbox.checked?divEachRow.setAttribute("data-selected","yes"):divEachRow.setAttribute("data-selected","no")},spanFirst.appendChild(inputCheckbox);var spanSecond=document.createElement("span");spanSecond.textContent=domainText;var spanThird=document.createElement("span");spanThird.textContent=pathText;var spanForth=document.createElement("span");spanForth.textContent=fileText,divEachRow.appendChild(spanFirst),divEachRow.appendChild(spanSecond),divEachRow.appendChild(spanThird),divEachRow.appendChild(spanForth),modalImportDivResources.appendChild(divEachRow)}catch(e){console.log("error in extracting url parts")}}))}function importTourNameAlreadyExist(){var tourNameArray;return!!JSON.parse(inputTourArray.value).includes(importObj.tourName)}function updateImportResourceWithNew(config,oldUrl,newUrl){for(let key in config.scenes){var scene=config.scenes[key];scene.panorama===oldUrl&&(scene.panorama=newUrl),scene.thumbnail===oldUrl&&(scene.thumbnail=newUrl),scene.preview===oldUrl&&(scene.preview=newUrl);for(let i in scene.hotSpots){var hotSpot=scene.hotSpots[i];hotSpot.infoImage===oldUrl&&(hotSpot.infoImage=newUrl),hotSpot.infoVideo===oldUrl&&(hotSpot.infoVideo=newUrl)}}}}();